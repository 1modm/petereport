{% extends 'home/template.html' %}

{% load i18n %}
{% load martortags %}
{% load bleach_tags %}

{% block title %} {% translate "Report Details" %} {% endblock title %}

{% block stylesheets %}
  {{ block.super }}
{% endblock stylesheets %}

{% block content %}


    <section class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">

          <div class="col-sm-6">
            <h4>Report</h4>
          </div>
          <div class="col-sm-6">
            <ol class="breadcrumb float-sm-right">
              <li class="breadcrumb-item"><a href="/">{% translate "Home" %}</a></li>
              <li class="breadcrumb-item"><a href="/customer/view/{{ DB_report_query.product.customer.pk}}">{{ DB_report_query.product.customer.name | bleach}}</a></li>
              <li class="breadcrumb-item"><a href="/product/view/{{ DB_report_query.product.pk}}">{{ DB_report_query.product.name | bleach}}</a></li>
              <li class="breadcrumb-item active">{{ DB_report_query.title | bleach}}</li>
            </ol>
          </div>
        </div>


         <br>

        <div class="row">
            <div class="col-md-5">
              <a href="/report/findings/{{ DB_report_query.pk }}"><button type="button" class="btn btn-danger"><i class="fa fa-bug"></i> {% translate "Findings" %}</button></a>
              <a href="/report/appendix/{{ DB_report_query.pk }}"><button type="button" class="btn btn-success"><i class="fa fa-folder"></i> {% translate "Appendix" %}</button></a>
              <a href="/report/attackflow/{{ DB_report_query.pk }}"><button type="button" class="btn btn-warning"><i class="fa fa-sitemap"></i> {% translate "Attack Flows" %}</button></a>

            </div>

            <div class="input-group col-md-7 text-right">
                <select style="margin-right: 2px" class="custom-select" id="exportSelect">
                  <option value="" selected="selected" id="chooseOptionSelect">Choose your Export...</option>
                  <option value="CSV">CSV</option>
                  {% if 'pdf' in templates_directories %}
                  <optgroup label="PDF">
                    {% for cst in templates_directories.pdf %}
                    <option value="{{ cst }}" export-type="pdf">PDF > {{ cst }}</option>
                    {% endfor %}
                  </optgroup>
                  {% endif %}
                  {% if 'markdown' in templates_directories %}
                  <optgroup label="Markdown">
                    {% for cst in templates_directories.markdown %}
                    <option value="{{ cst }}" export-type="markdown">Markdown > {{ cst }}</option>
                    {% endfor %}
                  </optgroup>
                  {% endif %}
                  {% if 'jupyter' in templates_directories %}
                  <optgroup label="Jupyter">
                    {% for cst in templates_directories.jupyter %}
                    <option value="{{ cst }}" export-type="jupyter">Jupyter > {{ cst }}</option>
                    {% endfor %}
                  </optgroup>
                  {% endif %}
                  {% if 'html' in templates_directories %}
                  <optgroup label="HTML">
                    {% for cst in templates_directories.html %}
                    <option value="{{ cst }}" export-type="html">HTML > {{ cst }}</option>
                    {% endfor %}
                  </optgroup>
                  {% endif %}
                </select>
                <button style="margin-right: 2px" type="button" class="btn btn-info" id="exportButton">{% translate "Export" %}</button>
            </div>
        </div>

        <div class="modal modal-danger fade mm-savereport-modal" id="pleaseWaitDialogSaveReport" data-backdrop="static" data-keyboard="false" role="dialog">
          <div class="modal-dialog">
              <div class="modal-content">
                  <div class="modal-header">
                      <h4 class="modal-title">Please wait...</h4>
                  </div>
                  <div class="modal-body">
                      <div class="progress">
                        <div class="progress-bar progress-bar-success progress-bar-striped active" role="progressbar"
                        aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width:100%; height: 40px">
                        </div>
                      </div>
                  </div>

              </div>
          </div>
      </div>

      <br>

      </div>
    </section>



    <section class="content">
      <div class="container-fluid">


      <div class="row">
        <div class="col-md-12">

            <div class="card card-outline card-success">
                <div class="card-header">
                  <h3 class="card-title">
                    <i class="far fa-chart-bar"></i>
                    <b>{% translate "Executive Summary" %}</b>
                  </h3>
                  <div class="card-tools">
                    <button type="button" class="btn btn-tool" data-card-widget="collapse" title="Collapse">
                      <i class="fas fa-minus"></i>
                    </button>
                  </div>

                </div>

                <div class="card-body">

                      <div class="row">

                        <div class="col-2 text-center">

                            {% if count_findings_critical > 0 %}
                              <input type="text" value="{{count_findings_critical}}" class="dial" data-min="0" data-max="{{count_findings_critical}}" data-fgColor="#cc0000" data-readOnly=true data-width="60%">
                            {% else %}
                              <input type="text" value="{{count_findings_critical}}" class="dial" data-min="0" data-max="{{count_findings_critical}}" data-fgColor="#D3D3D3" data-readOnly=true data-width="60%">
                            {% endif %}

                        <h3>{% translate "Critical" %}</h3>

                        </div>

                        <div class="col-2 text-center">

                            {% if count_findings_high > 0 %}
                              <input type="text" value="{{count_findings_high}}" class="dial" data-min="0" data-max="{{count_findings_high}}" data-fgColor="#f50000" data-readOnly=true data-width="60%">
                            {% else %}
                              <input type="text" value="{{count_findings_high}}" class="dial" data-min="0" data-max="{{count_findings_high}}" data-fgColor="#D3D3D3" data-readOnly=true data-width="60%">
                            {% endif %}

                        <h3>{% translate "High" %}</h3>
                        </div>


                        <div class="col-2 text-center">

                            {% if count_findings_medium > 0 %}
                              <input type="text" value="{{count_findings_medium}}" class="dial" data-min="0" data-max="{{count_findings_medium}}" data-fgColor="#fc7f03" data-readOnly=true data-width="60%">
                            {% else %}
                              <input type="text" value="{{count_findings_medium}}" class="dial" data-min="0" data-max="{{count_findings_medium}}" data-fgColor="#D3D3D3" data-readOnly=true data-width="60%">
                            {% endif %}

                        <h3>{% translate "Medium" %}</h3>
                        </div>

                        <div class="col-2 text-center">

                            {% if count_findings_low > 0 %}
                              <input type="text" value="{{count_findings_low}}" class="dial" data-min="0" data-max="{{count_findings_low}}" data-fgColor="#05b04f" data-readOnly=true data-width="60%">
                            {% else %}
                              <input type="text" value="{{count_findings_low}}" class="dial" data-min="0" data-max="{{count_findings_low}}" data-fgColor="#D3D3D3" data-readOnly=true data-width="60%">
                            {% endif %}

                        <h3>{% translate "Low" %}</h3>
                        </div>


                        <div class="col-2 text-center">

                            {% if count_findings_info > 0 %}
                              <input type="text" value="{{count_findings_info}}" class="dial" data-min="0" data-max="{{count_findings_info}}" data-fgColor="#45a7f7" data-readOnly=true data-width="60%">
                            {% else %}
                              <input type="text" value="{{count_findings_info}}" class="dial" data-min="0" data-max="{{count_findings_info}}" data-fgColor="#D3D3D3" data-readOnly=true data-width="60%">
                            {% endif %}

                        <h3>{% translate "Info" %}</h3>
                        </div>

                        <div class="col-2 text-center">

                            {% if count_findings_none > 0 %}
                              <input type="text" value="{{count_findings_none}}" class="dial" data-min="0" data-max="{{count_findings_none}}" data-fgColor="#999999" data-readOnly=true data-width="60%">
                            {% else %}
                              <input type="text" value="{{count_findings_none}}" class="dial" data-min="0" data-max="{{count_findings_none}}" data-fgColor="#D3D3D3" data-readOnly=true data-width="60%">
                            {% endif %}

                        <h3>{% translate "None" %}</h3>
                        </div>

                      </div>

                  <hr>
                  <div class="row">
                    <div class="col-12 col-sm-4">
                      <div class="info-box bg-light">
                        <div class="info-box-content">
                          <span class="info-box-number text-center text-muted">{% translate "Creation date" %}</span>
                          <span class="info-box-text text-center text-muted mb-0">{{ DB_report_query.creation_date|date:"Y-m-d H:i:s" | safe | bleach}}</span>
                        </div>
                      </div>
                    </div>
                    <div class="col-12 col-sm-4">
                      <div class="info-box bg-light">
                        <div class="info-box-content">
                          <span class="info-box-number text-center text-muted">{% translate "Report Dates" %}</span>
                          <span class="info-box-text text-center text-muted mb-0">{{ DB_report_query.report_date|date:"Y-m-d" | safe | bleach}}</span>
                          <span class="info-box-text text-center text-muted mb-0">{{ DB_report_query.audit_start|date:"Y-m-d" | safe | bleach}} → {{ DB_report_query.audit_end|date:"Y-m-d" | safe | bleach}}</span>
                        </div>
                      </div>
                    </div>
                    <div class="col-12 col-sm-4">
                      <div class="info-box bg-light">
                        <div class="info-box-content">
                          <span class="info-box-number text-center text-muted">{% translate "Product" %}</span>
                          <span class="info-box-text text-center text-muted mb-0">{{ DB_report_query.product.name | safe | bleach}}<span>
                        </span></span></div>
                      </div>
                    </div>
                  </div>


                  <div class="row">
                    <div class="col-12 col-sm-4">
                      <div class="info-box bg-light">
                        <div class="info-box-content">
                          <span class="info-box-number text-center text-muted">{% translate "Report" %}</span>
                          <span class="info-box-text text-center text-muted mb-0">{{ DB_report_query.title | safe | bleach}}</span>
                        </div>
                      </div>
                    </div>
                    <div class="col-12 col-sm-4">
                      <div class="info-box bg-light">
                        <div class="info-box-content">
                          <span class="info-box-number text-center text-muted">{% translate "Findings" %}</span>
                          <span class="info-box-text text-center text-muted mb-0">{{ count_finding_query | safe | bleach}}</span>
                        </div>
                      </div>
                    </div>
                    <div class="col-12 col-sm-4">
                      <div class="info-box bg-light">
                        <div class="info-box-content">
                          <span class="info-box-number text-center text-muted">{% translate "Report ID" %}</span>
                          <span class="info-box-text text-center text-muted mb-0">{{ DB_report_query.report_id | safe | bleach}}<span>
                        </span></span></div>
                      </div>
                    </div>
                  </div>


                  <div class="row">
                    <div class="col-md-12">
                        <div class="card card-outline">
                          <div class="card-body">
                            {{ DB_report_query.executive_summary | safe_markdown | bleach}}
                          </div>
                        </div>
                    </div>
                  </div>


                </div>
              </div>

        </div>
      </div>




      <!-- ---------------------------------------- -->

      <div class="row">
        <div class="col-md-12">

            <div class="card card-outline card-success">
                <div class="card-header">
                  <h3 class="card-title">
                    <b>{% translate "Breakdown by Severity" %}</b>
                  </h3>
                  <div class="card-tools">
                    <button type="button" class="btn btn-tool" data-card-widget="collapse" title="Collapse">
                      <i class="fas fa-minus"></i>
                    </button>
                  </div>

                </div>
                <div class="card-body">

                  <center>
                    <div id="SeveritybarChartEcharts" style="width:80%; height:500px;"></div>
                  </center>

                </div>
              </div>

        </div>
      </div>




      <div class="row">
        <div class="col-md-12">

            <div class="card card-outline card-success">
                <div class="card-header">
                  <h3 class="card-title">
                    <b>{% translate "Breakdown by CWE Categories" %}</b>
                  </h3>
                  <div class="card-tools">
                    <button type="button" class="btn btn-tool" data-card-widget="collapse" title="Collapse">
                      <i class="fas fa-minus"></i>
                    </button>
                  </div>

                </div>
                <div class="card-body">

                  <center>
                    <div id="CWEPieChartEcharts" style="width:100%; height:450px;"></div>
                  </center>

                </div>
              </div>

        </div>
      </div>

      <div class="row">
        <div class="col-md-12">

            <div class="card card-outline card-success">
                <div class="card-header">
                  <h3 class="card-title">
                    <b>{% translate "Breakdown by OWASP Categories" %}</b>
                  </h3>
                  <div class="card-tools">
                    <button type="button" class="btn btn-tool" data-card-widget="collapse" title="Collapse">
                      <i class="fas fa-minus"></i>
                    </button>
                  </div>

                </div>
                <div class="card-body">

                  <center>
                    <div id="OWASPPieChartEcharts" style="width:100%; height:450px;"></div>
                  </center>

                </div>
              </div>

        </div>
      </div>

      <!-- ---------------------------------------- -->


      <div class="row">
        <div class="col-md-12">

            <div class="card card-outline card-success">
                <div class="card-header">
                  <h3 class="card-title">
                    <b>{% translate "Scope" %}</b>
                  </h3>
                  <div class="card-tools">
                    <button type="button" class="btn btn-tool" data-card-widget="collapse" title="Collapse">
                      <i class="fas fa-minus"></i>
                    </button>
                  </div>

                </div>
                <div class="card-body">

                  {{ DB_report_query.scope | safe_markdown | bleach}}

                </div>
              </div>

        </div>
      </div>

      <div class="row">
        <div class="col-md-12">

            <div class="card card-outline card-success">
                <div class="card-header">
                  <h3 class="card-title">
                    <b>{% translate "Out of Scope" %}</b>
                  </h3>
                  <div class="card-tools">
                    <button type="button" class="btn btn-tool" data-card-widget="collapse" title="Collapse">
                      <i class="fas fa-minus"></i>
                    </button>
                  </div>

                </div>
                <div class="card-body">

                  {{ DB_report_query.outofscope | safe_markdown | bleach}}

                </div>
              </div>

        </div>
      </div>

      <div class="row">
        <div class="col-md-12">

            <div class="card card-outline card-success">
                <div class="card-header">
                  <h3 class="card-title">
                    <b>{% translate "Methodology" %}</b>
                  </h3>
                  <div class="card-tools">
                    <button type="button" class="btn btn-tool" data-card-widget="collapse" title="Collapse">
                      <i class="fas fa-minus"></i>
                    </button>
                  </div>

                </div>
                <div class="card-body">

                  {{ DB_report_query.methodology | safe_markdown | bleach}}

                </div>
              </div>

        </div>
      </div>



      <div class="row">
        <div class="col-md-12">

            <div class="card card-outline card-success">
                <div class="card-header">
                  <h3 class="card-title">
                    <b>{% translate "Recommendation" %}</b>
                  </h3>
                  <div class="card-tools">
                    <button type="button" class="btn btn-tool" data-card-widget="collapse" title="Collapse">
                      <i class="fas fa-minus"></i>
                    </button>
                  </div>

                </div>
                <div class="card-body">

                  {{ DB_report_query.recommendation | safe_markdown | bleach}}

                </div>
              </div>
        </div>
      </div>



      <div class="row">
        <div class="col-md-12">

            <div class="card card-outline card-success">
                <div class="card-header">
                  <h3 class="card-title">
                    <b>{% translate "Tags" %}</b>
                  </h3>
                  <div class="card-tools">
                    <button type="button" class="btn btn-tool" data-card-widget="collapse" title="Collapse">
                      <i class="fas fa-minus"></i>
                    </button>
                  </div>

                </div>
                <div class="card-body">

                  {{ report_tags | safe_markdown | bleach}}

                </div>
              </div>

        </div>
      </div>

      <div class="row">
        <div class="col-md-12">

            <div class="card card-outline card-danger">
                <div class="card-header">
                  <h3 class="card-title">
                    <b>{{ count_finding_query }} {% translate "Finding" %}{{ count_finding_query|pluralize:"s" }}</b>
                  </h3>
                  <div class="card-tools">
                    <button type="button" class="btn btn-tool" data-card-widget="collapse" title="Collapse">
                      <i class="fas fa-minus"></i>
                    </button>
                  </div>

                </div>
                <div class="card-body">

                     <div class="row">
                      <div class="col-md-12">

                      {% if count_finding_query == 0 %}

                        <a href="/finding/add/{{ DB_report_query.pk }}"><button type="button" class="btn btn-success btn-xm" data-toggle="modal">{% translate "Add Findings" %}</button></a>

                      {% else %}

                        <table id="findinglist" class="table table-bordered table-hover">

                        <thead>
                          <tr>
                            <th style="width: 40%">{% translate "Title" %}</th>
                            <th style="width: 5%">{% translate "Status" %}</th>
                            <th style="width: 5%">{% translate "Severity" %}</th>
                            <th style="width: 10%">{% translate "CVSS Score" %}</th>
                            <th style="width: 5%">{% translate "CWE" %}</th>
                            <th style="width: 5%">{% translate "OWASP" %}</th>
                            <th style="width: 30%"class="text-center">{% translate "Actions" %}</th>
                          </tr>
                        </thead>

                        <tbody>
                          {% for finding in DB_finding_query %}
                          <tr>
                                  <td>
                                    {{ finding.title | safe_markdown | bleach}}
                                  </td>
                                  <td>
                                    {{ finding.status | safe_markdown | bleach}}
                                  </td>

                                  <td>

                                        {% if finding.severity == "Critical" %}
                                            <b><font color="#CC0000">{{ finding.severity }}</font></b>
                                        {% elif finding.severity == "High" %}
                                            <b><font color="#F20000">{{ finding.severity }}</font></b>
                                        {% elif finding.severity == "Medium" %}
                                            <b><font color="#FC7F03">{{ finding.severity }}</font></b>
                                        {% elif finding.severity == "Low" %}
                                            <b><font color="#05B04F">{{ finding.severity }}</font></b>
                                        {% elif finding.severity == "Info" %}
                                            <b><font color="#45A7F7">{{ finding.severity }}</font></b>
                                        {% else %}
                                            <b>{{ finding.severity }}</b> ({% translate "will not appear in the report" %})
                                        {% endif %}

                                  </td>
                                  <td>
                                      {{ finding.cvss_score }}
                                  </td>
                                  <td>
                                    {% if finding.cwe.cwe_id == -1 %}
                                      -
                                    {% else %}
                                      <a href="https://cwe.mitre.org/data/definitions/{{finding.cwe.cwe_id}}.html">{{ finding.cwe.cwe_id }}</a>
                                    {% endif %}
                                  </td>
                                  <td>
                                    {% if finding.owasp.owasp_id == -1 %}
                                      -
                                    {% else %}
                                      <a href="{{ finding.owasp.owasp_url }}">{{ finding.owasp.owasp_full_id }}</a>
                                    {% endif %}
                                  </td>
                                  <td align="center">
                                      <a href="/finding/view/{{ finding.pk }}"><button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target=".bs-example-modal-sm"><i class="fa fa-folder"></i> {% translate "View" %}</button></a>

                                      {% if user.groups.all.0|stringformat:'s' == "administrator" %}
                                        <a href="/finding/edit/{{ finding.pk }}"><button type="button" class="btn btn-info btn-sm" data-toggle="modal" data-target=".bs-example-modal-sm"><i class="fa fa-edit"></i> {% translate "Edit" %}</button></a>
                                        <button type="button" class="btn btn-warning btn-sm" data-toggle="modal" data-target=".mm-modal-clone-{{finding.pk}}"><i class="fas fa-copy"></i> {% translate "Clone" %} </button>
                                        <button type="button" class="btn btn-danger btn-sm" data-toggle="modal" data-target=".mm-modal-del-{{finding.pk}}"><i class="fas fa-trash"></i> {% translate "Delete" %}</button>
                                      {% endif %}

                                  </td>

                          </tr>

                          <div class="modal modal-danger fade mm-modal-del-{{finding.pk}}" id="modal-danger">
                            <div class="modal-dialog">
                              <div class="modal-content bg-danger">
                                <div class="modal-header">
                                  <h4 class="modal-title">{% translate "Are you sure?" %}</h4>
                                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                  </button>
                                </div>
                                <div class="modal-body">
                                  <p>{% translate "Delete Finding" %}&hellip;</p>
                                </div>
                                <div class="modal-footer justify-content-between">
                                  <button type="button" class="btn btn-outline-light" data-dismiss="modal">{% translate "Close" %}</button>
                                  <button type="button" onclick="DeleteID({{finding.pk}});" class="btn btn-outline-light">{% translate "Delete Finding" %}</button>
                                </div>
                              </div>
                            </div>
                          </div>

                          <div class="modal modal-warning fade mm-modal-clone-{{finding.pk}}" id="modal-warning">
                            <div class="modal-dialog">
                              <div class="modal-content bg-warning">
                                <div class="modal-header">
                                  <h4 class="modal-title">{% translate "Are you sure?" %}</h4>
                                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                  </button>
                                </div>
                                <div class="modal-body">
                                  <p>{% translate "Clone Finding" %}&hellip;</p>
                                </div>
                                <div class="modal-footer justify-content-between">
                                  <button type="button" class="btn btn-outline-light" data-dismiss="modal">{% translate "Close" %}</button>
                                  <button type="button" onclick="DuplicateID({{finding.pk}});" class="btn btn-outline-light">{% translate "Clone Finding" %}</button>
                                </div>
                              </div>
                            </div>
                          </div>

                          {% endfor %}

                        </tbody>
                      </table>


                      {% endif %}

                      </div>

                    </div>

                </div>
              </div>

        </div>
      </div>



      <div class="row">
        <div class="col-md-12">

            <div class="card card-outline card-danger">
                <div class="card-header">
                  <h3 class="card-title">
                    <b>{{ DB_appendix_query.count }} {% translate "Appendix" %}</b>
                  </h3>
                  <div class="card-tools">
                    <button type="button" class="btn btn-tool" data-card-widget="collapse" title="Collapse">
                      <i class="fas fa-minus"></i>
                    </button>
                  </div>

                </div>
                <!-- /.card-header -->
                <div class="card-body">


                  <div class="row">
                    <div class="col-md-12">

                      {% if count_appendix_query == 0 %}

                        <a href="/appendix/add/{{ DB_report_query.pk }}"><button type="button" class="btn btn-success btn-xm">{% translate "Add Appendix" %}</button></a>

                      {% else %}

                      <table id="appendixlist" class="table table-bordered table-hover">

                        <thead>
                          <tr>
                            <th style="width: 35%">{% translate "Title" %}</th>
                            <th style="width: 40%">{% translate "Finding" %}</th>
                            <th style="width: 25%"class="text-center">{% translate "Actions" %}</th>
                          </tr>
                        </thead>


                        <tbody>
                          {% for appendix in DB_appendix_query %}
                          <tr>

                            <td>
                                {{appendix.title| safe_markdown | bleach}}
                            </td>


                            <td>
                                {% for finding in appendix.finding.all %}
                                  {{finding.title| safe_markdown | bleach}}
                                {% endfor %}
                            </td>
                            <td align="center">
                                <a href="/appendix/view/{{ appendix.pk }}"><button type="button" class="btn btn-primary btn-sm"><i class="fa fa-folder"></i> {% translate "View" %}</button></a>

                                {% if user.groups.all.0|stringformat:'s' == "administrator" %}
                                  <a href="/appendix/edit/{{ appendix.pk }}"><button type="button" class="btn btn-info btn-sm"><i class="fa fa-edit"></i> {% translate "Edit" %}</button></a>
                                  <button type="button" class="btn btn-danger btn-sm" data-toggle="modal" data-target=".mm-appendix-modal-{{appendix.pk}}"><i class="fas fa-trash"></i> {% translate "Delete" %}</button>
                                {% endif %}

                            </td>

                          </tr>

                          <div class="modal modal-danger fade mm-appendix-modal-{{appendix.pk}}" id="modal-danger">
                            <div class="modal-dialog">
                              <div class="modal-content bg-danger">
                                <div class="modal-header">
                                  <h4 class="modal-title">{% translate "Are you sure?" %}</h4>
                                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                  </button>
                                </div>
                                <div class="modal-body">
                                  <p>{% translate "Delete appendix" %}&hellip;</p>
                                </div>
                                <div class="modal-footer justify-content-between">
                                  <button type="button" class="btn btn-outline-light" data-dismiss="modal">{% translate "Close" %}</button>
                                  <button type="button" onclick="DeleteID_A({{appendix.pk}});" class="btn btn-outline-light">{% translate "Delete Appendix" %}</button>
                                </div>
                              </div>
                            </div>
                          </div>


                          {% endfor %}

                        </tbody>
                      </table>

                    {% endif %}


                    </div>

                  </div>

                </div>
              </div>

        </div>
      </div>






      <div class="row">
        <div class="col-md-12">

            <div class="card card-outline card-danger">
                <div class="card-header">
                  <h3 class="card-title">
                    <b>{{ DB_attackflow_query.count }} {% translate "Attack Flows" %}</b>
                  </h3>
                  <div class="card-tools">
                    <button type="button" class="btn btn-tool" data-card-widget="collapse" title="Collapse">
                      <i class="fas fa-minus"></i>
                    </button>
                  </div>

                </div>
                <!-- /.card-header -->
                <div class="card-body">


                  <div class="row">
                    <div class="col-md-12">

                      {% if count_attackflow_query == 0 %}

                        <a href="/attackflow/add/{{ DB_report_query.pk }}"><button type="button" class="btn btn-success btn-xm">{% translate "Add Attack Flow" %}</button></a>

                      {% else %}

                      <table id="attackt" class="table table-bordered table-hover">

                        <thead>
                          <tr>
                            <th style="width: 35%">{% translate "Title" %}</th>
                            <th style="width: 40%">{% translate "Finding" %}</th>
                            <th style="width: 25%" class="text-center">{% translate "Actions" %}</th>
                          </tr>
                        </thead>


                        <tbody>
                          {% for attackflow in DB_attackflow_query %}
                          <tr>

                            <td>
                                {{attackflow.title| safe_markdown | bleach}}
                            </td>


                            <td>
                                {% for finding in attackflow.finding.all %}
                                  {{finding.title| safe_markdown | bleach}}
                                {% endfor %}
                            </td>

                            <td align="center">
                                {% if user.groups.all.0|stringformat:'s' == "administrator" %}
                                  <a href="/attackflow/edit/{{ attackflow.pk }}"><button type="button" class="btn btn-info btn-sm"><i class="fa fa-edit"></i> {% translate "Edit" %}</button></a>
                                  <button type="button" class="btn btn-danger btn-sm" data-toggle="modal" data-target=".mm-attackflow-modal-{{attackflow.pk}}"><i class="fas fa-trash"></i> {% translate "Delete" %}</button>
                                {% endif %}

                            </td>

                          </tr>

                          <div class="modal modal-danger fade mm-attackflow-modal-{{attackflow.pk}}" id="modal-danger">
                            <div class="modal-dialog">
                              <div class="modal-content bg-danger">
                                <div class="modal-header">
                                  <h4 class="modal-title">{% translate "Are you sure?" %}</h4>
                                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                  </button>
                                </div>
                                <div class="modal-body">
                                  <p>{% translate "Delete Attack Flow" %}&hellip;</p>
                                </div>
                                <div class="modal-footer justify-content-between">
                                  <button type="button" class="btn btn-outline-light" data-dismiss="modal">{% translate "Close" %}</button>
                                  <button type="button" onclick="DeleteID_AT({{attackflow.pk}});" class="btn btn-outline-light">{% translate "Delete Attack Flow" %}</button>

                                </div>
                              </div>
                            </div>
                          </div>


                          {% endfor %}

                        </tbody>
                      </table>

                    {% endif %}


                    </div>

                  </div>

                </div>
              </div>

        </div>
      </div>






      </div>
    </section>





{% endblock content %}

{% block javascripts %}
  {{ block.super }}

<script>
    $(function() {
        $(".dial").knob();
    });
</script>

<script>
    $('.dial').trigger(
        'configure',
        {
            "min":0,
            "max":10,
            "fgColor":"#FF0000",
            "skin":"tron",
            "cursor":true
        }
    );
</script>


<script>
  $(function () {
    $("#findinglist").DataTable({
      "paging": true,
      "searching": true,
      "responsive": true,
      "lengthChange": false,
      "autoWidth": false,
      "buttons": ["copy", "csv", "excel", "pdf", "print", "colvis"],
      order: [[ 3, 'desc' ], [ 1, 'asc' ], [ 0, 'asc' ]]
    }).buttons().container().appendTo('#findinglist_wrapper .col-md-6:eq(0)');
  });
</script>

<script>
  $(function () {
    $("#appendixlist").DataTable({
      "paging": true,
      "searching": true,
      "responsive": true,
      "lengthChange": false,
      "autoWidth": false,
      "buttons": ["copy", "csv", "excel", "pdf", "print", "colvis"]
    }).buttons().container().appendTo('#appendixlist_wrapper .col-md-6:eq(0)');
  });
</script>

<script>
  $(function () {
    $("#attackt").DataTable({
      "paging": true,
      "searching": true,
      "responsive": true,
      "lengthChange": false,
      "autoWidth": false,
      "buttons": ["copy", "csv", "excel", "pdf", "print", "colvis"]
    }).buttons().container().appendTo('#attackt_wrapper .col-md-6:eq(0)');
  });
</script>





<script type="text/javascript">
        var chartSeveritybar = echarts.init(document.getElementById('SeveritybarChartEcharts'));

        var option = {
            title: {
            },
            tooltip: {},
            legend: {
                data:['Severity']
            },
            toolbox: {
              show: false,
              feature: {
                  saveAsImage: {
                    show: true,
                    title: "Save Image",
                    name: "Breakdown_by_Severity"
                  }
              }
            },
            xAxis: {
                type: 'category',
                data: [{
                  value: "Critical",
                  textStyle: {
                    fontSize:15
                  }
                 },{
                  value: "High",
                  textStyle: {
                    fontSize:15
                  }
                 }, {
                  value: "Medium",
                  textStyle: {
                    fontSize:15
                  }
                 } , {
                  value: "Low",
                  textStyle: {
                    fontSize:15
                  }
                 }, {
                  value: "Info",
                  textStyle: {
                    fontSize:15
                  }
                 }]
            },
            yAxis: {
              type: 'value',
              interval: 1,
              axisLabel:{
               fontSize: 12
              }
            },

            series: [{
                type: 'bar',
                stack: 1,
                animation: false,
            bars: {
                show: false,
                barWidth: 0.2,
                fill:10
            },

            data: [

                {
                    value: {{count_findings_critical}},
                    itemStyle: {color: '#cc0000'},
                },
                {
                    value: {{count_findings_high}},
                    itemStyle: {color: '#ff403d'},
                },
                {
                    value: {{count_findings_medium}},
                    itemStyle: {color: '#fc7f03'},
                },
                {
                    value: {{count_findings_low}},
                    itemStyle: {color: '#05b04f'},
                },
                {
                    value: {{count_findings_info}},
                    itemStyle: {color: '#45a7f7'},
                }
              ]
            }]
        };

        chartSeveritybar.setOption(option);

</script>




<script type="text/javascript">
    var chart_CWE = echarts.init(document.getElementById('CWEPieChartEcharts'));

    var option_CWE = {
            tooltip: {
                trigger: 'item',
                formatter: '{b} <br>{c}'
            },
            toolbox: {
              show: false,
              feature: {
                  saveAsImage: {
                    show: true,
                    title: "Save Image",
                    name: "Breakdown_by_CWE_Categories"
                  }
              }
            },
            series: [
                {
                    name: 'CWE',
                    type: 'pie',
                    radius: '70%',
                    animation: false,

                    data: {{cwe_categories|safe}},
                    labelLine: {
                        show: true
                    },
                    emphasis: {
                        itemStyle: {
                            shadowBlur: 10,
                            shadowOffsetX: 0,
                            shadowColor: 'rgba(0, 0, 0, 0.5)'
                        }
                    }
                }
            ]
    };

    chart_CWE.setOption(option_CWE);

</script>


<script type="text/javascript">
  var chart_OWASP = echarts.init(document.getElementById('OWASPPieChartEcharts'));

  var option_OWASP = {
          tooltip: {
              trigger: 'item',
              formatter: '{b} <br>{c}'
          },
          toolbox: {
            show: false,
            feature: {
                saveAsImage: {
                  show: true,
                  title: "Save Image",
                  name: "Breakdown_by_OWASP_Categories"
                }
            }
          },
          series: [
              {
                  name: 'OWASP',
                  type: 'pie',
                  radius: '70%',
                  animation: false,

                  data: {{owasp_categories|safe}},
                  labelLine: {
                      show: true
                  },
                  emphasis: {
                      itemStyle: {
                          shadowBlur: 10,
                          shadowOffsetX: 0,
                          shadowColor: 'rgba(0, 0, 0, 0.5)'
                      }
                  }
              }
          ]
  };

  chart_OWASP.setOption(option_OWASP);

</script>



<script>

  $(function() {
    $('#exportButton').hide();

    $('#exportSelect').on('change', function() {
        if ($('#exportSelect').find(':selected').attr('id') == 'chooseOptionSelect') {
          $('#exportButton').hide();
        } else {
          $('#exportButton').show();
        }
    });

    $('#exportButton').on('click', function() {
      var cst = $('#exportSelect').find(':selected').val();
      if (cst == 'CSV') {
        document.location.href = "/finding/csv/{{ DB_report_query.pk }}";
      } else {
        var export_type = $('#exportSelect').find(':selected').attr('export-type');
        SaveReport(export_type, cst);
      }
    });
  });

  function SaveReport(export_type, cst) {
        $("#pleaseWaitDialogSaveReport").modal("show");

        var imgSeveritybar = new Image();
        imgSeveritybar.src = chartSeveritybar.getDataURL({
            pixelRatio: 2,
            backgroundColor: '#fff'
        });

        var imgCWE = new Image();
        imgCWE.src = chart_CWE.getDataURL({
            pixelRatio: 2,
            backgroundColor: '#fff'
        });

        var imgOWASP = new Image();
        imgOWASP.src = chart_OWASP.getDataURL({
            pixelRatio: 2,
            backgroundColor: '#fff'
        });

        $.ajax({
            type: 'POST',
            url: "/en/report/uploadsummaryfindings/{{ DB_report_query.pk }}", // prepend a language code or even better: use window.location.href
            headers:{ "X-CSRFToken": '{{ csrf_token }}' },
            data : { 'fileSeveritybar': imgSeveritybar.src, 'file_cwe': imgCWE.src, 'file_owasp': imgOWASP.src },
            success : function(json) {
                //console.log("requested complete");
                if (json.status == 'success'){
                    //window.open('/report/download/pdf/{{ DB_report_query.pk }}', '_blank');
                    document.location.href = "/report/download/" + export_type + "/" +  cst + "/{{ DB_report_query.pk }}";
                    $("#pleaseWaitDialogSaveReport").modal("hide");
                  }
            }
        });
  };

</script>


<script>
  function DeleteID(del_id) {
        $.ajax({
            type: 'POST',
            url: "/en/finding/delete/",
            headers:{
              "X-CSRFToken": '{{ csrf_token }}'
            },
            data : { 'delete_id': del_id},

            success : function(json) {
              document.location.href = "/report/view/{{DB_report_query.pk}}";
            }
        })
  }
</script>
<script>
function DuplicateID(dup_id) {
  $.ajax({
      type: 'POST',
      url: "/en/finding/duplicate/",
      headers:{
        "X-CSRFToken": '{{ csrf_token }}'
      },
      data : { 'duplicate_id': dup_id},

      success : function(json) {
        document.location.href = "/report/view/{{DB_report_query.pk}}";
      }
  })
}
</script>

<script>
  function DeleteID_A(del_id) {
        $.ajax({
            type: 'POST',
            url: "/en/appendix/delete/",
            headers:{
              "X-CSRFToken": '{{ csrf_token }}'
            },
            data : { 'delete_id': del_id},

            success : function(json) {
              document.location.href = "/report/view/{{DB_report_query.pk}}";
            }
        })
  }
</script>


<script>
  function DeleteID_AT(del_id) {
        $.ajax({
            type: 'POST',
            url: "/en/attackflow/delete/",
            headers:{
              "X-CSRFToken": '{{ csrf_token }}'
            },
            data : { 'delete_id': del_id},

            success : function(json) {
              document.location.href = "/report/view/{{DB_report_query.pk}}";
            }
        })
  }
</script>

{% endblock javascripts %}
